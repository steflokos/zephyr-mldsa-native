# Copyright (c) The mlkem-native project authors
# Copyright (c) The mldsa-native project authors
# SPDX-License-Identifier: Apache-2.0 OR ISC OR MIT

# Metadata for test configuration files
# Each entry describes how a test config differs from mldsa/config.h

configs:
  - path: test/no_asm_config.h
    description: "Test configuration with no assembly code"
    defines:
      MLD_CONFIG_NO_ASM: true
      MLD_CONFIG_CUSTOM_ZEROIZE:
        content: |
          #define MLD_CONFIG_CUSTOM_ZEROIZE
          #if !defined(__ASSEMBLER__)
          #include <stdint.h>
          #include <string.h>
          #include "../mldsa/src/sys.h"
          static MLD_INLINE void mld_zeroize_native(void *ptr, size_t len)
          {
            explicit_bzero(ptr, len);
          }
          #endif

  - path: test/serial_fips202_config.h
    description: "Test configuration with serial FIPS202 only"
    defines:
      MLD_CONFIG_SERIAL_FIPS202_ONLY: true

  - path: test/custom_randombytes_config.h
    description: "Test configuration with custom randombytes"
    defines:
      MLD_CONFIG_CUSTOM_RANDOMBYTES:
        content: |
          #define MLD_CONFIG_CUSTOM_RANDOMBYTES
          #if !defined(__ASSEMBLER__)
          #include <stdint.h>
          #include "../mldsa/src/sys.h"
          #include "notrandombytes/notrandombytes.h"
          static MLD_INLINE void mld_randombytes(uint8_t *ptr, size_t len)
          {
            randombytes(ptr, len);
          }
          #endif /* !__ASSEMBLER__ */

  - path: test/custom_zeroize_config.h
    description: "Test configuration with custom zeroize"
    defines:
      MLD_CONFIG_CUSTOM_ZEROIZE:
        content: |
          #define MLD_CONFIG_CUSTOM_ZEROIZE
          #if !defined(__ASSEMBLER__)
          #include <stdint.h>
          #include <string.h>
          #include "../mldsa/src/sys.h"
          static MLD_INLINE void mld_zeroize_native(void *ptr, size_t len)
          {
            explicit_bzero(ptr, len);
          }
          #endif

  - path: test/custom_memcpy_config.h
    description: "Test configuration with custom memcpy"
    defines:
      MLD_CONFIG_CUSTOM_MEMCPY:
        content: |
          #define MLD_CONFIG_CUSTOM_MEMCPY
          #if !defined(__ASSEMBLER__)
          #include <stddef.h>
          #include <stdint.h>
          #include "../mldsa/src/sys.h"
          static MLD_INLINE void *mld_memcpy(void *dest, const void *src, size_t n)
          {
            /* Simple byte-by-byte copy implementation for testing */
            unsigned char *d = (unsigned char *)dest;
            const unsigned char *s = (const unsigned char *)src;
            for (size_t i = 0; i < n; i++)
            {
              d[i] = s[i];
            }
            return dest;
          }
          #endif /* !__ASSEMBLER__ */

  - path: test/custom_memset_config.h
    description: "Test configuration with custom memset"
    defines:
      MLD_CONFIG_CUSTOM_MEMSET:
        content: |
          #define MLD_CONFIG_CUSTOM_MEMSET
          #if !defined(__ASSEMBLER__)
          #include <stddef.h>
          #include <stdint.h>
          #include "../mldsa/src/sys.h"
          static MLD_INLINE void *mld_memset(void *s, int c, size_t n)
          {
            /* Simple byte-by-byte set implementation for testing */
            unsigned char *ptr = (unsigned char *)s;
            for (size_t i = 0; i < n; i++)
            {
              ptr[i] = (unsigned char)c;
            }
            return s;
          }
          #endif

  - path: test/custom_stdlib_config.h
    description: "Test configuration with custom stdlib functions"
    defines:
      MLD_CONFIG_CUSTOM_MEMCPY:
        content: |
          #define MLD_CONFIG_CUSTOM_MEMCPY
          #if !defined(__ASSEMBLER__)
          #include <stddef.h>
          #include <stdint.h>
          #include "../mldsa/src/sys.h"
          static MLD_INLINE void *mld_memcpy(void *dest, const void *src, size_t n)
          {
            /* Simple byte-by-byte copy implementation for testing */
            unsigned char *d = (unsigned char *)dest;
            const unsigned char *s = (const unsigned char *)src;
            for (size_t i = 0; i < n; i++)
            {
              d[i] = s[i];
            }
            return dest;
          }
          #endif /* !__ASSEMBLER__ */
      MLD_CONFIG_CUSTOM_MEMSET:
        content: |
          #define MLD_CONFIG_CUSTOM_MEMSET
          #if !defined(__ASSEMBLER__)
          #include <stddef.h>
          #include <stdint.h>
          #include "../mldsa/src/sys.h"
          static MLD_INLINE void *mld_memset(void *s, int c, size_t n)
          {
            /* Simple byte-by-byte set implementation for testing */
            unsigned char *ptr = (unsigned char *)s;
            for (size_t i = 0; i < n; i++)
            {
              ptr[i] = (unsigned char)c;
            }
            return s;
          }
          #endif

  - path: test/break_pct_config.h
    description: "Test configuration for PCT breakage testing"
    defines:
      MLD_CONFIG_KEYGEN_PCT: true
      MLD_CONFIG_KEYGEN_PCT_BREAKAGE_TEST:
        content: |
          #define MLD_CONFIG_KEYGEN_PCT_BREAKAGE_TEST
          #if !defined(__ASSEMBLER__)
          #include <stdlib.h>
          #include <string.h>
          #include "../mldsa/src/sys.h"
          static MLD_INLINE int mld_break_pct(void)
          {
            /* Break PCT if and only if MLD_BREAK_PCT is set to 1 */
            const char *val = getenv("MLD_BREAK_PCT");
            return val != NULL && strcmp(val, "1") == 0;
          }
          #endif

  - path: test/custom_native_capability_config_0.h
    description: "Test configuration with custom capability function returning 0"
    defines:
      MLD_CONFIG_CUSTOM_CAPABILITY_FUNC:
        content: |
          #define MLD_CONFIG_CUSTOM_CAPABILITY_FUNC
          #if !defined(__ASSEMBLER__)
          #include "../mldsa/src/sys.h"
          /* System capability enumeration */

          static MLD_INLINE int mld_sys_check_capability(mld_sys_cap cap)
          {
            (void)cap; /* Ignore parameter */
            return 0;
          }
          #endif /* !__ASSEMBLER__ */

  - path: test/custom_native_capability_config_1.h
    description: "Test configuration with custom capability function returning 1"
    defines:
      MLD_CONFIG_CUSTOM_CAPABILITY_FUNC:
        content: |
          #define MLD_CONFIG_CUSTOM_CAPABILITY_FUNC
          #if !defined(__ASSEMBLER__)
          #include "../mldsa/src/sys.h"

          static MLD_INLINE int mld_sys_check_capability(mld_sys_cap cap)
          {
            (void)cap; /* Ignore parameter */
            return 1;
          }
          #endif /* !__ASSEMBLER__ */

  - path: test/custom_native_capability_config_CPUID_AVX2.h
    description: "Test configuration with CPUID-based AVX2 capability detection"
    defines:
      MLD_CONFIG_CUSTOM_CAPABILITY_FUNC:
        content: |
          #define MLD_CONFIG_CUSTOM_CAPABILITY_FUNC
          #if !defined(__ASSEMBLER__)
          #include <stdint.h>
          #include "../mldsa/src/sys.h"

          /* Assert this config is only used on Linux/x86_64 systems */
          #if !defined(MLD_SYS_X86_64) || !defined(MLD_SYS_LINUX)
          #error "This configuration is only supported on Linux/x86_64 systems"
          #endif

          static MLD_INLINE int mld_sys_check_capability(mld_sys_cap cap)
          {
            if (cap == MLD_SYS_CAP_AVX2)
            {
              uint32_t eax, ebx, ecx, edx;

              /* AVX2 support is queried using `cpuid` with EAX=7, ECX=0.
               * Check first if `cpuid` supports EAX=7 by calling it with
               * EAX=0, which gives the maximum supported value of EAX in
               * EAX. */

              __asm__ volatile("cpuid"
                               : "=a"(eax), "=b"(ebx), "=c"(ecx), "=d"(edx)
                               : "a"(0));

              if (eax < 7)
              {
                return 0; /* Extended features not supported */
              }

              __asm__ volatile("cpuid"
                               : "=a"(eax), "=b"(ebx), "=c"(ecx), "=d"(edx)
                               : "a"(7), "c"(0));

              /* AVX2 is bit 5 in EBX */
              return (ebx & (1 << 5)) ? 1 : 0;
            }

            /* Default to 0 (conservative) for unknown capabilities */
            return 0;
          }
          #endif /* !__ASSEMBLER__ */

  # Example configs

  - path: examples/monolithic_build/config_44.h
    description: "Monolithic build config for ML-DSA-44 (native backends disabled)"
    defines:
      MLD_CONFIG_PARAMETER_SET: 44
      MLD_CONFIG_NAMESPACE_PREFIX: mldsa
      MLD_CONFIG_INTERNAL_API_QUALIFIER: static
      MLD_CONFIG_FILE:
        comment: "/* No need to set this -- we _are_ already in a custom config */"

  - path: examples/monolithic_build/config_65.h
    description: "Monolithic build config for ML-DSA-65 (native backends disabled)"
    defines:
      MLD_CONFIG_PARAMETER_SET: 65
      MLD_CONFIG_NAMESPACE_PREFIX: mldsa
      MLD_CONFIG_INTERNAL_API_QUALIFIER: static
      MLD_CONFIG_FILE:
        comment: "/* No need to set this -- we _are_ already in a custom config */"

  - path: examples/monolithic_build/config_87.h
    description: "Monolithic build config for ML-DSA-87 (native backends disabled)"
    defines:
      MLD_CONFIG_PARAMETER_SET: 87
      MLD_CONFIG_NAMESPACE_PREFIX: mldsa
      MLD_CONFIG_INTERNAL_API_QUALIFIER: static
      MLD_CONFIG_FILE:
        comment: "/* No need to set this -- we _are_ already in a custom config */"

  - path: examples/monolithic_build_native/config_44.h
    description: "Monolithic build config for ML-DSA-44 (native backends disabled)"
    defines:
      MLD_CONFIG_PARAMETER_SET: 44
      MLD_CONFIG_NAMESPACE_PREFIX: mldsa
      MLD_CONFIG_USE_NATIVE_BACKEND_ARITH: true
      MLD_CONFIG_USE_NATIVE_BACKEND_FIPS202: true
      MLD_CONFIG_INTERNAL_API_QUALIFIER: static
      MLD_CONFIG_FILE:
        comment: "/* No need to set this -- we _are_ already in a custom config */"

  - path: examples/monolithic_build_native/config_65.h
    description: "Monolithic build config for ML-DSA-65 (native backends disabled)"
    defines:
      MLD_CONFIG_PARAMETER_SET: 65
      MLD_CONFIG_NAMESPACE_PREFIX: mldsa
      MLD_CONFIG_USE_NATIVE_BACKEND_ARITH: true
      MLD_CONFIG_USE_NATIVE_BACKEND_FIPS202: true
      MLD_CONFIG_INTERNAL_API_QUALIFIER: static
      MLD_CONFIG_FILE:
        comment: "/* No need to set this -- we _are_ already in a custom config */"

  - path: examples/monolithic_build_native/config_87.h
    description: "Monolithic build config for ML-DSA-87 (native backends disabled)"
    defines:
      MLD_CONFIG_PARAMETER_SET: 87
      MLD_CONFIG_NAMESPACE_PREFIX: mldsa
      MLD_CONFIG_USE_NATIVE_BACKEND_ARITH: true
      MLD_CONFIG_USE_NATIVE_BACKEND_FIPS202: true
      MLD_CONFIG_INTERNAL_API_QUALIFIER: static
      MLD_CONFIG_FILE:
        comment: "/* No need to set this -- we _are_ already in a custom config */"

  - path: examples/monolithic_build_multilevel/multilevel_config.h
    description: "Multilevel monolithic build config"
    defines:
      MLD_CONFIG_NAMESPACE_PREFIX: mldsa
      MLD_CONFIG_INTERNAL_API_QUALIFIER: static
      MLD_CONFIG_FILE:
        comment: "/* No need to set this -- we _are_ already in a custom config */"

  - path: examples/monolithic_build_multilevel_native/multilevel_config.h
    description: "Multilevel monolithic build config with native backends"
    defines:
      MLD_CONFIG_NAMESPACE_PREFIX: mldsa
      MLD_CONFIG_USE_NATIVE_BACKEND_ARITH: true
      MLD_CONFIG_USE_NATIVE_BACKEND_FIPS202: true
      MLD_CONFIG_INTERNAL_API_QUALIFIER: static
      MLD_CONFIG_EXTERNAL_API_QUALIFIER: static
      MLD_CONFIG_FILE:
        comment: "/* No need to set this -- we _are_ already in a custom config */"
      MLD_CONFIG_CUSTOM_RANDOMBYTES:
        comment: |
          /* Even though we use the default randombytes signature here, registering it
           * as a custom implementation avoids double-declaration of randombytes via
           * mldsa/src/randombytes.h and test_only_rng/notrandombytes.h: The former is by
           * default included by mldsa-native, and the latter is needed for this example
           * since we rely on the additional randombytes_reset() API. */
        content: |
          #define MLD_CONFIG_CUSTOM_RANDOMBYTES
          #if !defined(__ASSEMBLER__)
          #include <stdint.h>
          #include "sys.h"
          #include "test_only_rng/notrandombytes.h"
          static MLD_INLINE void mld_randombytes(uint8_t *ptr, size_t len)
          {
            randombytes(ptr, len);
          }
          #endif /* !__ASSEMBLER__ */

  - path: examples/basic_deterministic/mldsa_native/custom_no_randomized_config.h
    description: "Config without randomized API"
    defines:
      MLD_CONFIG_NO_RANDOMIZED_API: true
      MLD_CONFIG_FILE:
        comment: "/* No need to set this -- we _are_ already in a custom config */"
